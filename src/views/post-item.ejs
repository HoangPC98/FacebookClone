<link rel="stylesheet" href="/css/homecss/home-newfeed.css">
<link rel="stylesheet" href="/css/homecss/home-post-box.css">

<div class="post-item">
    <!-- append HTML here -->
    <%- include('list-like') %>
</div>


<script>
    // fetch API Posts

    let exdate = new Date();
    exdate = exdate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: '2-digit'
    })
    console.log(exdate)
    let PostApi = '/api/posts'
    async function CallApi() {
        await fetch(PostApi)
            .then(response => {
                return response.json()
            })
            .then(data => {

                let posts_data = []
                data.map(item => {
                    // console.log( item.createdAt.toLocaleDateString('en-US',{ year: 'numeric', month: 'long', day: '2-digit'}))
                    console.log('item created', item.createdAt)
                    posts_data.push(item)
                })
                posts_data.reverse()
                return posts_data
            })
            .then((result) => {
                console.log(result)
                DisplayPostData(result)
            })
    }
    CallApi()

    function DisplayPostData(posts_data) {
        let likeStatus
        posts_data.map(item => {

            if (item.reactDetail.listLikeUser.includes(dataUserId)) {
                likeStatus = true
            } else {
                likeStatus = false
            }
            console.log('like Status', likeStatus)

            // Call ListComment API 


            let item_append = `
            <div class="newsfeed item-post" id="${item._id}">
                <div class="newsfeed__info">
                    <div class="newsfeed__info-profile">
                        <img class="newsfeed__-profile-avt"
                            src="https://icons.iconarchive.com/icons/papirus-team/papirus-status/512/avatar-default-icon.png">
                        <div class="newsfeed__info-profile-more">
                            <div class="newfeed_postId"> ${item._id}</div>

                            <span class="newsfeed__info-name">
                                ${dataUserId}
                            </span>
                            <div class="newsfeed__info-time">
                                ${item.createdAt}

                                <i class="fas fa-globe-europe"></i>
                            </div>
                        </div>
                    </div>
                    <div class="newsfeed__info-setting more-dots">
                        <i class="fas fa-ellipsis-h"></i>
                        <ul class="newsfeed__info-setting-list" >
                            <li class="newsfeed__info-setting-item">
                                <div class="newsfeed__info-setting-item__img">
                                    <i class="fas fa-cloud-download"></i>
                                </div>
                                <div class="newsfeed__info-setting-item__content">
                                    <p class="newsfeed__info-setting-item__text">
                                        Lưu bài viết
                                    </p>
                                    <p class="newsfeed__info-setting-item__title">
                                        Thêm danh sách vào mục đã lưu.
                                    </p>
                                </div>
                            </li>
                            <div>
                                <li class="newsfeed__info-setting-item">
                                    <div class="newsfeed__info-setting-item__img">
                                        <i class="fas fa-link"></i>
                                    </div>
                                    <div class="newsfeed__info-setting-item__content">
                                        <p class="newsfeed__info-setting-item__text">
                                            Nhúng
                                        </p>
                                    </div>
                                </li>
                                <li class="newsfeed__info-setting-item">
                                    <div class="newsfeed__info-setting-item__img">
                                        <i class="far fa-bell"></i>
                                    </div>
                                    <div class="newsfeed__info-setting-item__content">
                                        <p class="newsfeed__info-setting-item__text">
                                            Bật thông báo về bài viết.
                                        </p>
                                    </div>
                                </li>
                                <li style="display: flex" class="newsfeed__info-setting-item edit-post">
                                    <div class="newsfeed__info-setting-item__img">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    <div class="newsfeed__info-setting-item__content">
                                        <p class="newsfeed__info-setting-item__text">
                                            Chỉnh sửa bài viết
                                        </p>
                                    </div>
                                </li>
                                <li style="display: flex" class="newsfeed__info-setting-item delete-post">
                                    <div class="newsfeed__info-setting-item__img">
                                        <i class="fas fa-trash-alt"></i>
                                    </div>
                                    <div class="newsfeed__info-setting-item__content">
                                        <p class="newsfeed__info-setting-item__text">
                                            Chuyển vào thùng rác
                                        </p>
                                        <p class="newsfeed__info-setting-item__title">
                                            Các mục trong thùng rác sẽ bị xoá sau 30 ngày.
                                        </p>
                                    </div>
                                </li>
                            </div>
                            <li class="newsfeed__info-setting-item">
                                <div class="newsfeed__info-setting-item__img">
                                    <i class="fas fa-ban"></i>
                                </div>
                                <div class="newsfeed__info-setting-item__content">
                                    <p class="newsfeed__info-setting-item__text">
                                        Ẩn bài viết
                                    </p>
                                    <p class="newsfeed__info-setting-item__title">
                                        Ẩn bớt các bài viết tương tự
                                    </p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="newsfeed__content">
                    <p class="newsfeed__content-text">
                        ${item.content}
                    </p>
                    <img style="display: block " src="https://miro.medium.com/max/3686/1*OWpoPsr8wK1DKmXfi_4d4Q.png" alt=""
                        class="newsfeed__content-img">
                </div>

                <div class="newsfeed__respond">
                    <div title="" style="display: flex" class="newsfeed__respond-react">
                        <div class="newsfeed__respond-react-icon">
                            <i class="fas fa-thumbs-up"></i>
                        </div>
                        <span class="newsfeed__respond-like-total" style="font-size: 14px">
                            ${item.reactNumber.likeNumber}
                        </span>
                    </div>
                    <div style="display: flex" class="newsfeed__respond-right">
                        <span class="newsfeed__respond-comment-total">${item.reactNumber.commentNumber} </span>
                        <span> bình luận </span>
                        <span> __ </span>
                        <span class="newsfeed__respond-share-total">${item.reactNumber.shareNumber}</span>
                        <span> chia sẻ </span>

                    </div>
                </div>

                <ul data-index="" class="newsfeed__action">
                    <li
                        class="newsfeed__action-item reaction ${likeStatus ? 'active' : ''}">
                        <i class="fas fa-thumbs-up newsfeed__action-item-icon"></i>
                        <span class="newsfeed__action-item-text">Thích</span>
                    </li>
                    <li class="newsfeed__action-item comment-action">
                        <i class="far fa-comment-alt newsfeed__action-item-icon"></i>
                        <span class="newsfeed__action-item-text">Bình luận</span>
                    </li>
                    <li class="newsfeed__action-item">
                        <i class="fas fa-share newsfeed__action-item-icon"></i>
                        <span class="newsfeed__action-item-text">Chia sẻ</span>
                    </li>
                </ul>

                <div class="newsfeed__comment">
                    <div class="newsfeed__comment-user">
                        <img src="https://icons.iconarchive.com/icons/papirus-team/papirus-status/512/avatar-default-icon.png" alt="" class="nav-wall newsfeed__comment-img avt">
                        <div class="newsfeed__comment-box">
                            <input type="text" placeholder="Viết bình luận ..."
                                class="newsfeed__comment-input">
                            <div class="newsfeed__comment-box-right">
                                <div class="newsfeed__comment-box-icon test">
                                    <i class="far fa-laugh-beam"></i>
                                </div>
                                <div class="newsfeed__comment-box-icon">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <div class="newsfeed__comment-box-icon send-comment" style="display: none">
                                    <i class="fas fa-paper-plane"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="newsfeed__commented-box">
                        <div class="commented-switch">
                            <div class="show-hide-cmt commented-switch__text">
                                Tất cả bình luận
                            </div>
                            <div class="commented-switch__text">
                                Phù hợp nhất
                                <i class="fad fa-caret-down"></i>
                            </div>
                        </div>
                        <div class="commented-box">
                            
                        </div>     
                    </div>       
                </div>  
            </div>
           
            `
            $('.post-item').append(item_append)

        })
        // FUnction Get PostID via All ParentNode
        var getPostId = function (elem) {
            var parents = [];
            for (; elem && elem !== document; elem = elem.parentNode) {
                parents.push(elem);
            }
            var postItemClicked
            parents.map(itemParent => {
                if (itemParent.classList.contains('item-post')) {
                    // postIdClicked = itemParent.id
                    postItemClicked = itemParent
                    // console.log('postIDCliedk', postIdClicked)
                }

            })
            return postItemClicked
        }



        // Click to the Show Hide Comment
        $('.show-hide-cmt').click(async function (e) {

           


            let postId = getPostId(e.target).id
            let postItem = getPostId(e.target)
            console.log('postID....', postId)
            let HideShow = postItem.querySelector('.show-hide-cmt.commented-switch__text')
            await fetch(`/api/get-comments/${postId} `)
                .then((response) => {
                    console.log('FETCH API COMMET SUCESSFULLY', response)
                    return response.json()
                })
                .then(data => {
                    console.log('data json', data)
                    let CommentPostShow = getPostId(e.target).querySelector('.commented-box')
                    console.log('CommentPostShow', CommentPostShow)
                    if( CommentPostShow.classList.contains('active')){
                        CommentPostShow.classList.remove('active')
                        HideShow.innerHTML = 'Ẩn bớt'
                    }
                    else{
                        CommentPostShow.classList.add('active')
                        HideShow.innerHTML = 'Tất cả bình luận'
                    }
                    

                    let allComment = ''
                    data.map(comment_item => {
                        allComment +=
                        `<div class="commented-box__item">
                            <div class="commented-box__item-user">
                                <div class="commented-box__item-avatar">
                                    <img src="https://img1.daumcdn.net/thumb/R800x0/?scode=mtistory2&fname=https:%2F%2Fblog.kakaocdn.net%2Fdn%2Fb65Ohg%2Fbtrci8yToa0%2Fzy8bkTKPAHR0OQUg4mfeTK%2Fimg.png"  alt="">
                                </div>
                                <div class="commented-box__item-info">
                                    <div class="wrap">
                                        <div class="comented-box__item-content">
                                            <div class="oninput">
                                                ${comment_item.uid}
                                            </div>
                                            <div class="comented-box__item-text">
                                                ${comment_item.comment}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="commented-box__item-reaction" data-index="${comment_item.uid}">
                                        <span class=" commented-box__item-reaction--like">Thích</span>
                                        •
                                        <span class="commented-box__item-reaction--respond">Phản hồi</span>
                                    </div>
                                    <div style="display:" class="commented-count-reaction">
                                        <i class="fas fa-thumbs-up"></i>
                                        <span>cmt.like</span>
                                    </div>
                                </div>
                                <div data-index="${comment_item.uid}" class="commented-box__item-delete" >
                                    <i class="fad fa-trash-alt"></i>
                                </div>
                            </div>
                        </div>    
                        `
                
                    })
                    CommentPostShow.innerHTML = allComment
                  
                })
                .catch((error) => {
                    console.log("FETCH COMMENT- SERVER ERROR", error)
                })
        })

        // function get All Parents 


        let FetchPostData = async function (apiUrl, data) {
            // console.log('data passed', data)
            post = {
                method: 'POST',
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                },
                body: JSON.stringify(data)
            }
            await fetch(apiUrl, post)
                .then(dataFetch => {
                    console.log('POST SENDED', dataFetch)
                })

        }
        // Click Send COmment
        $('.item-post').click(function(e){

            let PostItemClicked = getPostId(e.target)
            let InputElementOnInputing = PostItemClicked.querySelector('.newsfeed__comment-input')
            
            let sentCmtBtn = PostItemClicked.querySelector('.send-comment')

            InputElementOnInputing.oninput = function () {
                console.log('20202',  InputElementOnInputing.parentElement)
                sentCmtBtn.style.display = `${this.value === "" ? 'none' : 'flex'}`
                // Click to Send Comment Button
               
            }

            sentCmtBtn.onclick = function () {
                console.log('CLIKEDDĐ')
                    let valueInputComment = InputElementOnInputing.value
                    console.log('SENT CMT', valueInputComment)
                    // Display Comment
                    InputElementOnInputing.value = ''
                    sentCmtBtn.style.display = 'none'
                    let postIdClicked = PostItemClicked.id
                
                    let commentData = {
                        postId: postIdClicked,
                        uid: dataUserId,
                        comment: valueInputComment
                    }
                    FetchPostData('/post-comment', commentData)
                }
        })

      




        postDataClicked = {}
        let listLikeUser

        $('.newsfeed__respond-react').click(function (e) {

            let postIdClicked = getPostId(e.target).id
          
            posts_data.map(item => {
                if (item._id === postIdClicked) {
                    console.log('pót_datamap item', postIdClicked)
                    listLikeUser = item.reactDetail.listLikeUser
                }
            })

            console.log('lis like user', listLikeUser)
            let userItem = ''

            fetch('/api/get-user-display')
                .then(response => {
                    return response.json()
                })
                .then(data => {
                    // console.log("FETCH DATA0", data)
                    data.map((data_item, index) => {
                        // console.log('Fetch item mapping',index)
                        if (listLikeUser.includes(data_item.uid)) {
                            console.log('Fetch item mathc', index, )

                            userItem += `
                                <li class="container-right__connect-item flex-roww">
                                    <div class="left-section flex-roww">
                                        <span class="container-right__connect-item-avatar">
                                            <img src="${data_item.avatar}" alt="" class="container-right__connect-item-img">
                                        </span>
                                        <span class="container-right__connect-item-name">${data_item.uid}</span>
                                    </div>
                                    <button type="button" class="btn btn-active" style="font-size:14px">Thêm bạn bè</button>
                                </li>
                                `
                        }
                    })
                    $('.list-user').html(userItem)


                })

            // đổ data xong r mới display ra
            document.querySelector('.list-like').style.display = 'block'


        })




        // Handle Post Like Status
        console.log('POST DATA OUT', posts_data)

        function PostLikeStatus(user_id) {
            console.log('CHECK LIKE STAUS', user_id, posts_data)
            let likeStatus
            posts_data.map((post_item, index) => {
                console.log('mapping post item', index)
                if (post_item.reactDetail.listLikeUser.includes(user_id)) {
                    likeStatus = true
                    console.log('liks status', likeStatus)
                }
            })
        }

        PostLikeStatus(dataUserId)

        // })

        // handle click Like button
        $('.newsfeed__action-item.reaction').click(function (e) {

            var postItem = getPostId(e.target)
            var postId = getPostId(e.target).id
            let selector = postItem.querySelector('.newsfeed__respond-like-total')
                    if (this.classList.contains('active')) {
                        this.classList.remove('active')
                        selector.innerHTML = (Number(selector.innerHTML) - 1)
                        PostLikeAction({
                            postId: postId,
                            change: 'des',
                            userChange: dataUserId
                        })
                    } else {
                        this.classList.add('active')
                        selector.innerHTML = (Number(selector.innerHTML) + 1)
                        PostLikeAction({
                            postId: postId,
                            change: 'inc',
                            userChange: dataUserId
                        })
                    }
            console.log('parents', parents)
            parents.map(item => {

            })
            console.log('this', this)

        })

        let PostLikeAction = function (param) {
            console.log('param', param)
            option = {
                method: 'post',
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                },
                body: JSON.stringify(param)
            }
            fetch('/like-change', option)

        }
    }
</script>